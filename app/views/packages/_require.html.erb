<div class="row cs-require-panels cs-no-margin hidden-xs">

  <%
    dependency_relations = {}

    dependency_relations["Requires"] = @package.active_dependencies.order(is_shallow: :desc).includes(depended: :counter)
    dependency_relations["Used By"] = @package.passive_dependencies.order(is_shallow: :desc).includes(dependent: :counter)
  %>

  <% dependency_relations.each do |name, assocs| %>

    <div class="col-sm-6">

      <div class="panel panel-default cs-no-margin">

        <div class="panel-heading">

          <h4 class="cs-no-margin">
            <%= name %>:
          </h4>

        </div>

        <div class="panel-body cs-no-padding">

          <div class="list-group">

            <%
              batch_total = 150
              substract_batch = 50

              assoc_list = assocs
                .order("counters.stargazer desc")
                .first(batch_total)

              if name == "Requires"
                assoc_tuples = assoc_list.map{ |a| [a.depended, a.is_shallow] }
              else
                assoc_tuples = assoc_list.map{ |a| [a.dependent, a.is_shallow] }
              end

              assoc_tuples.delete_if { |p, _| p.name == "Julia" }

              assoc_tuples.delete_if { |p, _| p.name == @package.name }

              assoc_tuples.delete_if { |p, _| not p.is_registered } \
                unless cookies[:include_unregistered_packages] == 'true'

              assoc_tuples = assoc_tuples.first(batch_total - substract_batch)
            %>

            <% if assoc_tuples.empty? %>

              <div class="list-group-item cs-no-padding">

                <div class="row-content cs-full-width cs-category-row">

                  <a class="btn btn-default cs-full-width cs-left-align cs-no-margin">
                    No Packages
                  </a>
                </div>

              </div>

            <% end %>

            <% assoc_tuples.each_with_index do |(package, is_shallow), index| %>

              <% unless index.zero? %>

                <div class="list-group-separator cs-full-width cs-no-margin"></div>

              <% end %>

              <div class="list-group-item cs-no-padding <%= "cs-is-indirect-dependency" unless is_shallow %>">

                <div class="row-content cs-full-width cs-category-row">

                  <%=
                    link_to package.name,
                      package_path(package),
                      class: "btn btn-default cs-full-width cs-left-align cs-no-margin #{ 'active' if current_page?(package_path(package)) }"
                  %>

                </div>

              </div>

            <% end %>

          </div>

        </div>

      </div>

    </div>

  <% end %>

</div>
